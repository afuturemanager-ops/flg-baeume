<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unsere gepflanzten Bäume</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background: #f6f8f6;
      color: #1f2937;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 14px;
    }

    .project-logo {
      height: 130px;
      margin-top: 28px;
      margin-bottom: 8px;
    }

    h1 {
      margin: 8px 0 6px;
      font-weight: 650;
      letter-spacing: 0.2px;
    }

    #counter {
      font-size: 76px;
      margin: 6px 0 22px;
      color: #1a7f37;
      font-weight: 850;
      line-height: 1;
    }

    #map {
      height: 520px;
      margin: 0 0 44px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
      background: #e5e7eb;
    }

    .hint {
      font-size: 13px;
      color: #6b7280;
      margin: -28px 0 28px;
    }

    @media (max-width: 520px) {
      .project-logo { height: 110px; }
      #counter { font-size: 64px; }
      #map { height: 460px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <img src="logo.png" class="project-logo" alt="FLG – Zukunft pflanzen Logo" />
    <h1>Unsere gepflanzten Bäume</h1>
    <div id="counter">0</div>
    <div id="map"></div>
    <div class="hint">Datenquelle: FLG_Baeume_Status.csv</div>
  </div>

  <script>
    // ---------- Karte ----------
    const map = L.map("map", { zoomControl: true }).setView([50.12, 8.45], 8);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap",
      maxZoom: 19
    }).addTo(map);

    // ---------- Helfer ----------
    function toNumber(v) {
      if (v === undefined || v === null) return NaN;
      return parseFloat(String(v).trim().replace(",", "."));
    }

    function markerRadius(count) {
      const n = Math.max(1, Number(count) || 1);
      const r = 6 + 5 * Math.log10(n);
      return Math.max(6, Math.min(22, r));
    }

    function animateCounter(target) {
      const el = document.getElementById("counter");
      const durationMs = 900;
      const startTime = performance.now();

      function step(now) {
        const t = Math.min(1, (now - startTime) / durationMs);
        const value = Math.round(target * t);
        el.textContent = value.toLocaleString("de-DE");
        if (t < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    function makeMarker(lat, lng, count, popupHtml) {
      return L.circleMarker([lat, lng], {
        radius: markerRadius(count),
        color: "#14532d",
        weight: 2,
        fillColor: "#1a7f37",
        fillOpacity: 0.85
      }).addTo(map).bindPopup(popupHtml);
    }

    function getRowValue(row, keys) {
      for (const k of keys) {
        if (row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== "") {
          return String(row[k]).trim();
        }
      }
      return "";
    }

    // ---------- CSV laden ----------
    Papa.parse("FLG_Baeume_Status.csv", {
      download: true,
      header: true,
      skipEmptyLines: true,
      delimiter: "",
      complete: function (results) {

        const rows = results?.data || [];
        let total = 0;
        const markers = [];

        rows.forEach((row) => {

          const ort = getRowValue(row, ["Ort", " Ort", "Ort "]);
          const anzahl = parseInt(getRowValue(row, ["Anzahl", " Anzahl"]), 10);
          const spender = getRowValue(row, ["Spender", " Spender", "Spender "]);

          const lat = toNumber(getRowValue(row, ["Breitengrad", " Breitengrad"]));
          const lng = toNumber(getRowValue(row, ["Längengrad", "Laengengrad", " Längengrad"]));

          if (!isNaN(anzahl)) total += anzahl;

          if (!isNaN(lat) && !isNaN(lng)) {

            const popupParts = [];
            popupParts.push(`<strong>${ort || "Ort"}</strong>`);
            if (!isNaN(anzahl)) popupParts.push(`${anzahl.toLocaleString("de-DE")} Bäume`);
            if (spender) popupParts.push(`Spender: ${spender}`);

            const popup = `
              <div style="font-family:Arial,sans-serif; line-height:1.35;">
                ${popupParts.join("<br/>")}
              </div>`;

            markers.push(makeMarker(lat, lng, anzahl, popup));
          }
        });

        animateCounter(total || 0);

        if (markers.length === 1) {
          map.setView(markers[0].getLatLng(), 12);
        } else if (markers.length > 1) {
          const group = new L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.2));
        }
      },
      error: function () {
        document.getElementById("counter").textContent = "Fehler";
      }
    });

  </script>
</body>
</html>
